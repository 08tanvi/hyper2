---
title: "The importance of serve in table tennis"
author: "Robin K. S. Hankin"
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{table_tennis_serve}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


# The importance of serve in table tennis.

Suppose We have three players, "a","b", and "c" who play table tennis.
We seek to quantify the effect of the serve.  The scoreline is as
follows:

* A vs B, A serves, 5-1
* A vs B, B serves, 1-3
* A vs C, A serves, 4-1
* A vs C, C serves, 1-2

(note that A does not play C).  This dataset is easily analysed with
the ```hyper2``` package although the model implicitly assumes that
the serve strength does not depend on who is serving.

```{r}
library("hyper2",quietly=TRUE)
```

The first step is to define a ```hyper2``` object:

```{r}
H <- hyper2(pnames=c("S","a","b","c"))
H
```

so the likelihood function is uniform, for the only term is raised to
the zeroth power.  Now we have to input the data, and we will go
through the four scorelines above, one by one.  Note that this
approach implicitly assumes independence of scores.


### A vs B, A serves, score 5-1:
```{r}
H[c("a","S")]     %<>% "+"(5  ) # a+S win 5 games
H["b"]            %<>% "+"(  1) # b wins 1 game
H[c("a","b","S")] %<>% "-"(5+1) # a+b+S play 1+5=6 games
H
```

The likelihood function is of the form
$\frac{\left(a+S\right)^5b}{\left(a+b+S\right)^6}$.  We can add the other observations to $H$:

### A vs B, B serves, score 1-3:
```{r}
H[c("b","S")]     %<>% "+"(3  ) # b+S win 3 games
H["a"]            %<>% "+"(  1) # a wins 1 game 
H[c("a","b","S")] %<>% "-"(3+1) # a+b+S play 1+3=4 games
```

### A vs C, A serves, score 4-1:
```{r}
H[c("a","S")]     %<>% "+"(4  ) # a+S win 4 games
H["c"]            %<>% "+"(  1) # c wins 1 game 
H[c("a","c","S")] %<>% "-"(4+1) # a+c+S play 1+4=5 games
```

### A vs C, C serves, score 1-2:
```{r}
H["a"]            %<>% "+"(1  ) # a wins 1 game
H[c("c","S")]     %<>% "+"(  2) # c+S win 2 games
H[c("a","c","S")] %<>% "-"(1+2) # a+c+S play 1+2=3 games
```


## Likelihood function

For the entire dataset we have

```{r}
H
```

Here $H$ is a likelihood function on $a,b,c,S$, algebraically
proportional to

\[
\frac{(S+a)^9(S+b)^3(S+c)^2a^2bc}{(S+a+b)^{10}(S+a+c)^8}
\]



# Results 
We now find the unconstrained MLE:

```{r}
p1 <- maxp(H)
p1
```

And we can find the support at this point:

```{r}
maxlike_free <- loglik(H,indep(p1))
maxlike_free
```

Now find the MLE conditional on the serve having zero strength:

```{r}
small <- 1e-6
maxlike_constrained <-
    constrOptim(
        f = function(p){loglik(H,p)},
        theta=c(small, 1/3-small/2, 1/3-small/2),
        grad=NULL,
        ui=rbind(diag(3),-diag(3),-1),
        ci=c(rep(small/2,3),c(-small*2,-1,-1),-1),
        control=list(fnscale = -1)  # finds max, not min
    )
```	

The difference in support is:

```{r}    	    
delta_support <- maxlike_free - maxlike_constrained$value
delta_support
```

and the likelihood ratio is:
```{r}
LR <- exp(delta_support)
LR
```

The difference in support, ```delta_support```, is about 2.62 which
exceeds Edwards's two-units-of-support criterion.  We can reject the
null.  Alternatively, Wilks's theorem gives us that
$\Lambda=2\log(LR)$ is distributed as chi-squared with one degree of
freedom:

```{r}
Lambda <- 2*delta_support
pval <- pchisq(Lambda,df=1,lower.tail=FALSE)
pval 
```

Thus the tail area, pval, is about 0.022 which gives us a significant
result.


Further, note that our maximum likelihood estimate for strengths
allows us to assess what might happen when A plays C (which was not
observed).  For convenience, here is the evaluate:

```{r}
maxp(H)
```

If A serves, we would have $A+S:C\simeq 0.24+0.45:0.16\equiv 69:16$,
or A wins with probability of about $0.81$.  If C serves we have
$A:C+S\simeq 0.24:0.16+0.45\equiv 24:61$, so A wins with a probability
of about $0.28$.



# Profile likelihood

We can give a profile likelihood for $S$ by maximizing the likelihood
of $(S,p_a,p_b,p_c)$ subject to a particular value of $S$ (in addition
to the unit sum constraint).  The following function defines a profile
likelihood function for $S$:

```{r}

profile_likelihood <- function(S,give=FALSE){

  objective <- function(pab){# pab=c(a,b); S in scope
    loglik(H,c(S,pab[1],pab[2]))  # no minus because we use fnscale= -1
  }
  
  maxlike_constrained <-           # 2 DoF, a,b [S is given]
    constrOptim(
        f = objective,
        theta=c(rep((1-S)/3,2)),   # start at indep([c(S,x,x,x)])
        grad=NULL,
        ui=rbind(diag(2),-1),      # pa,pb>=0, pa+pb <1-S
        ci=c(0,0,S-1),             # ditto
        control=list(fnscale = -1) # finds max, not min
    )

  if(give){
    return(maxlike_constrained)
  } else{
    return(maxlike_constrained$value)
  }
}
```

We can then evaluate the profile likelihood for a range of possible
values of $S$:

```{r}
S_vals <- seq(from=0.02,to=0.85,len=30)  # possible values for S
prof_like <- sapply(S_vals,profile_likelihood)  
plot(S_vals, prof_like-max(prof_like),xlab="serve strength",ylab="profile likelihood")
abline(h= -2)
```

So we can see that the credible range is from about 0.07-0.8 (and in
particular excludes zero).